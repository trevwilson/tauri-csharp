<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TauriCSharp Test App</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        h1 { color: #00d9ff; margin-bottom: 10px; }
        h2 { color: #888; font-size: 14px; font-weight: normal; margin-top: 0; }
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .section h3 {
            margin: 0 0 10px 0;
            color: #00d9ff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button {
            background: #0f3460;
            color: #fff;
            border: 1px solid #00d9ff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 13px;
        }
        button:hover { background: #00d9ff; color: #1a1a2e; }
        button:active { transform: scale(0.98); }
        #log {
            background: #0d1b2a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-entry { margin: 2px 0; }
        .log-info { color: #00d9ff; }
        .log-success { color: #00ff88; }
        .log-error { color: #ff6b6b; }
        .log-event { color: #ffd93d; }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-ok { background: #00ff88; color: #1a1a2e; }
        .status-error { background: #ff6b6b; color: #1a1a2e; }
    </style>
</head>
<body>
    <h1>TauriCSharp Test App</h1>
    <h2>wry-ffi Integration Tests</h2>
    <div id="status" class="status-ok">Ready</div>

    <div class="section">
        <h3>IPC Tests</h3>
        <button onclick="sendMessage('ping')">Send Ping</button>
        <button onclick="sendMessage('echo:Hello from JS!')">Echo Message</button>
        <button onclick="sendMessage('get-window-info')">Get Window Info</button>
    </div>

    <div class="section">
        <h3>Window Controls</h3>
        <button onclick="sendMessage('minimize')">Minimize</button>
        <button onclick="sendMessage('maximize')">Maximize</button>
        <button onclick="sendMessage('restore')">Restore</button>
        <button onclick="sendMessage('set-title:New Title!')">Set Title</button>
        <button onclick="sendMessage('resize:900x700')">Resize 900x700</button>
        <button onclick="sendMessage('move:100x100')">Move to 100,100</button>
    </div>

    <div class="section">
        <h3>WebView Tests</h3>
        <button onclick="sendMessage('execute-script')">Execute Script</button>
        <button onclick="sendMessage('open-devtools')">Open DevTools</button>
        <button onclick="sendMessage('get-url')">Get Current URL</button>
        <button onclick="sendMessage('navigate:https://example.com')">Navigate to example.com</button>
    </div>

    <div class="section">
        <h3>Dialogs</h3>
        <button onclick="sendMessage('dialog-open')">Open File</button>
        <button onclick="sendMessage('dialog-save')">Save File</button>
        <button onclick="sendMessage('dialog-confirm')">Confirm Dialog</button>
    </div>

    <div class="section">
        <h3>Phase 4 Features</h3>
        <button onclick="sendMessage('get-monitors')">Get Monitors</button>
        <button onclick="sendMessage('set-icon')">Set Icon</button>
        <button onclick="sendMessage('send-notification')">Send Notification</button>
        <button onclick="sendMessage('register-shortcut')">Register Ctrl+Shift+T</button>
        <button onclick="sendMessage('open-child-window')">Open Child Window</button>
        <button onclick="sendMessage('open-modal-window')">Open Modal Dialog</button>
        <button onclick="sendMessage('broadcast-message')">Broadcast to All</button>
    </div>

    <div class="section">
        <h3>Event Log</h3>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        // Log helper
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function setStatus(ok, message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = ok ? 'status-ok' : 'status-error';
        }

        // Send message to C# backend
        function sendMessage(message) {
            log(`Sending: ${message}`, 'info');
            try {
                // wry-ffi uses window.ipc.postMessage
                if (window.ipc && window.ipc.postMessage) {
                    window.ipc.postMessage(message);
                    log('Sent via window.ipc.postMessage', 'info');
                }
                // Fallback: check for tauri bridge
                else if (window.tauri && window.tauri.invoke) {
                    // For tauri.invoke, we'd wrap in a command structure
                    // But for simple messages, use raw IPC if available
                    log('tauri bridge available but using raw message', 'info');
                    window.tauri.invoke('message', { text: message });
                }
                // Legacy: window.external (Photino/older WebKit)
                else if (window.external && window.external.sendMessage) {
                    window.external.sendMessage(message);
                }
                // Legacy: Chrome WebView2
                else if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(message);
                }
                else {
                    log('No message bridge available!', 'error');
                    log('Checking: window.ipc=' + !!window.ipc + ', window.tauri=' + !!window.tauri, 'error');
                    setStatus(false, 'No bridge');
                }
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
                setStatus(false, 'Error');
            }
        }

        // Receive message from C# backend
        // wry-ffi calls this via evaluateScript when SendWebMessage is called
        function receiveMessage(message) {
            log(`Received: ${message}`, 'success');

            // Handle specific responses
            if (message.startsWith('pong')) {
                setStatus(true, 'IPC Working');
            } else if (message.startsWith('error:')) {
                setStatus(false, message.substring(6));
            }
        }

        // Expose receiveMessage globally for wry-ffi to call
        window.receiveMessage = receiveMessage;

        // Also set up legacy receivers
        if (window.external) {
            window.external.receiveMessage = receiveMessage;
        }
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.addEventListener('message', e => receiveMessage(e.data));
        }

        // Log startup
        log('Test app loaded', 'success');
        log(`User Agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');

        // Debug: Check what IPC mechanisms are available
        setTimeout(() => {
            log('IPC check: window.ipc = ' + (typeof window.ipc), 'info');
            log('IPC check: window.tauri = ' + (typeof window.tauri), 'info');
            log('IPC check: window.external = ' + (typeof window.external), 'info');
            if (window.ipc) {
                log('window.ipc.postMessage = ' + (typeof window.ipc.postMessage), 'info');
            }
        }, 500);
    </script>
</body>
</html>
